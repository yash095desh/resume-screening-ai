// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

  generator client {
    provider = "prisma-client-js"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  model User {
    id        String   @id // Clerk user ID
    email     String   @unique
    name      String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    jobs      Job[]
    
    @@map("users")
  }

  model Job {
    id                  String   @id @default(uuid())
    userId              String
    title               String
    description         String?  @db.Text // Plain text JD
    jdFileUrl           String?  // Cloudinary URL if uploaded as file
    requiredSkills      String[] // Array of required skills
    experienceRequired  String?
    qualifications      String[] // Array of qualifications
    status              String   @default("draft") // draft, processing, completed
    totalCandidates     Int      @default(0)
    createdAt           DateTime @default(now())
    updatedAt           DateTime @updatedAt
    
    user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    candidates          Candidate[]
    processingLogs      ProcessingLog[]
    
    @@index([userId])
    @@map("jobs")
  }

  model Candidate {
    id                    String   @id @default(uuid())
    jobId                 String
    name                  String
    email                 String?
    phone                 String?
    resumeUrl             String   // Supabase public URL
    resumePath            String   // NEW: path in Supabase bucket
    resumeText            String?  @db.Text
    
    // Extracted Information
    skills                String[]
    experience            Json?    // Array of experience objects
    education             Json?    // Array of education objects
    totalExperienceYears  Int?
    
    // Analysis Results
    matchScore            Int?     // 0-100
    matchedSkills         String[]
    missingSkills         String[]
    fitVerdict            String?  // Good Fit / Moderate Fit / Low Fit
    summary               String?  @db.Text // AI-generated summary
    strengths             String[]
    weaknesses            String[]
    
    // Processing Status
    processingStatus      String   @default("pending") // pending, processing, completed, failed
    processingError       String?  @db.Text
    
    createdAt             DateTime @default(now())
    updatedAt             DateTime @updatedAt
    
    job                   Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
    
    @@index([jobId])
    @@index([matchScore])
    @@map("candidates")
  }

  model ProcessingLog {
    id                String    @id @default(uuid())
    jobId             String
    status            String    // started, in_progress, completed, failed
    totalResumes      Int?
    processedResumes  Int       @default(0)
    failedResumes     Int       @default(0)
    errorMessage      String?   @db.Text
    startedAt         DateTime  @default(now())
    completedAt       DateTime?
    
    job               Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
    
    @@map("processing_logs")
  }