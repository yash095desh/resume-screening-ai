generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String            @id
  email                   String            @unique
  name                    String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  dailyEmailLimit         Int               @default(10)
  emailDomainPaused       Boolean           @default(false)
  emailDomainPausedAt     DateTime?
  emailDomainPausedReason String?
  emailDomainVerified     Boolean           @default(false)
  emailDomainVerifiedAt   DateTime?
  emailFromAddress        String?
  emailSubdomain          String?           @unique
  emailsSentToday         Int               @default(0)
  lastEmailResetAt        DateTime?
  resendDomainId          String?
  totalEmailsBounced      Int               @default(0)
  totalEmailsSent         Int               @default(0)
  totalSpamComplaints     Int               @default(0)
  warmupStartedAt         DateTime?
  sourcingJobs            SourcingJob[]
  email_templates         email_templates[]
  emails                  Email[]
  interviews              interviews[]
  jobs                    Job[]
  sequences               Sequence[]
  subscriptions           subscriptions?
  user_credits            user_credits?

  @@map("users")
}

model Job {
  id                 String          @id @default(uuid())
  userId             String
  title              String
  description        String?
  jdFileUrl          String?
  requiredSkills     String[]
  experienceRequired String?
  qualifications     String[]
  status             String          @default("draft")
  totalCandidates    Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  candidates         Candidate[]
  interviews         interviews[]
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  processingLogs     ProcessingLog[]

  @@index([userId])
  @@map("jobs")
}

model Candidate {
  id                   String              @id @default(uuid())
  jobId                String
  name                 String
  email                String?
  phone                String?
  resumeUrl            String
  resumeText           String?
  skills               String[]
  experience           Json?
  education            Json?
  totalExperienceYears Int?
  matchScore           Int?
  matchedSkills        String[]
  missingSkills        String[]
  fitVerdict           String?
  summary              String?
  strengths            String[]
  weaknesses           String[]
  processingStatus     String              @default("pending")
  processingError      String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  resumePath           String
  candidateSequences   CandidateSequence[]
  job                  Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  emails               Email[]
  interviews           interviews[]

  @@index([jobId])
  @@index([matchScore])
  @@map("candidates")
}

model ProcessingLog {
  id               String    @id @default(uuid())
  jobId            String
  status           String
  totalResumes     Int?
  processedResumes Int       @default(0)
  failedResumes    Int       @default(0)
  errorMessage     String?
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  job              Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("processing_logs")
}

model SourcingJob {
  id                  String              @id @default(cuid())
  userId              String
  title               String
  rawJobDescription   String
  maxCandidates       Int                 @default(50)
  searchFilters       Json?
  discoveredUrls      Json?
  status              SourcingJobStatus   @default(CREATED)
  totalProfilesFound  Int                 @default(0)
  profilesScraped     Int                 @default(0)
  profilesScored      Int                 @default(0)
  processingStartedAt DateTime?
  lastActivityAt      DateTime?
  errorMessage        String?
  retryCount          Int                 @default(0)
  failedAt            DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  completedAt         DateTime?
  scrapedProfilesData Json?
  parsedProfilesData  Json?
  currentStage        String?
  profilesParsed      Int                 @default(0)
  profilesSaved       Int                 @default(0)
  rateLimitHitAt      DateTime?
  rateLimitResetAt    DateTime?
  maxRetries          Int                 @default(3)
  jobRequirements     Json?
  lastCompletedStage  String?
  enrichedUrls        Json?
  rateLimitService    String?
  usedQueryIndices    Json?
  candidates          LinkedInCandidate[]
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviews          interviews[]

  @@index([userId, status])
  @@index([lastActivityAt])
  @@index([status, lastActivityAt])
}

model LinkedInCandidate {
  id                        String                    @id @default(cuid())
  sourcingJobId             String
  fullName                  String
  headline                  String?
  location                  String?
  profileUrl                String
  photoUrl                  String?
  currentPosition           String?
  currentCompany            String?
  experienceYears           Int?
  skills                    Json?
  experience                Json?
  education                 Json?
  email                     String?
  phone                     String?
  hasContactInfo            Boolean                   @default(false)
  matchScore                Float                     @default(0)
  skillsScore               Float                     @default(0)
  experienceScore           Float                     @default(0)
  industryScore             Float                     @default(0)
  titleScore                Float                     @default(0)
  matchReason               String?
  isScored                  Boolean                   @default(false)
  isDuplicate               Boolean                   @default(false)
  firstSeenJobId            String?
  batchNumber               Int                       @default(0)
  rawData                   Json?
  scrapedAt                 DateTime?
  scoredAt                  DateTime?
  bonusSkills               Json?
  certifications            Json?
  connections               Int?
  currentCompanyLogo        String?
  currentJobDuration        String?
  duplicateCount            Int                       @default(0)
  followers                 Int?
  industryMatch             String?
  isOpenToWork              Boolean                   @default(false)
  isPremium                 Boolean                   @default(false)
  isVerified                Boolean                   @default(false)
  languages                 Json?
  linkedInId                String?
  matchedSkills             Json?
  missingSkills             Json?
  niceToHaveScore           Float                     @default(0)
  publicIdentifier          String?
  relevantYears             Int?
  scoringVersion            String?
  seniorityLevel            String?
  updatedAt                 DateTime                  @updatedAt
  aiAnalysisVersion         String?                   @default("v3.0")
  analysisGeneratedAt       DateTime?
  candidateSummary          String?
  criticalGaps              Json?
  experienceAnalysisSummary String?
  experienceHighlights      Json?
  experienceRelevanceScore  Float?                    @default(0)
  fullAnalysisGenerated     Boolean                   @default(false)
  gapsAndTradeoffs          Json?
  gapsOverallImpact         String?
  gapsSummary               String?
  hasSignificantGaps        Boolean                   @default(false)
  industryAlignment         String?
  interviewConfidenceScore  Float?                    @default(0)
  interviewFocusAreas       Json?
  interviewFocusSummary     String?
  interviewReadiness        InterviewReadinessStatus  @default(NOT_ASSESSED)
  interviewReadinessReason  String?
  keyStrengths              Json?
  redFlags                  Json?
  seniorityAlignment        String?
  skillGapImpact            String?
  skillsAnalysisSummary     String?
  skillsProficiency         Json?
  suggestedQuestions        Json?
  emailSource               String?
  enrichedAt                DateTime?
  enrichmentStatus          CandidateEnrichmentStatus @default(PENDING)
  scrapingStatus            String?
  sourcingJob               SourcingJob               @relation(fields: [sourcingJobId], references: [id], onDelete: Cascade)
  candidateSequences        CandidateSequence[]
  emails                    Email[]
  interviews                interviews[]

  @@unique([sourcingJobId, profileUrl])
  @@index([sourcingJobId, matchScore(sort: Desc)])
  @@index([profileUrl])
  @@index([batchNumber])
  @@index([seniorityLevel])
  @@index([isOpenToWork])
}

model credit_transactions {
  id            String          @id
  userCreditsId String
  type          TransactionType
  category      CreditCategory
  amount        Int
  balanceAfter  Int
  referenceId   String?
  referenceType String?
  description   String?
  createdAt     DateTime        @default(now())
  user_credits  user_credits    @relation(fields: [userCreditsId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userCreditsId])
}

model plans {
  id               String          @id
  name             String
  slug             String          @unique
  priceInRupees    Int
  sourcingCredits  Int
  screeningCredits Int
  billingCycle     String          @default("monthly")
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  subscriptions    subscriptions[]
}

model subscriptions {
  id                 String             @id
  userId             String             @unique
  planId             String
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime           @default(now())
  currentPeriodEnd   DateTime
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  cancelledAt        DateTime?
  plans              plans              @relation(fields: [planId], references: [id])
  users              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, currentPeriodEnd])
  @@index([userId])
}

model user_credits {
  id                  String                @id
  userId              String                @unique
  sourcingCredits     Int                   @default(0)
  screeningCredits    Int                   @default(0)
  lastResetAt         DateTime              @default(now())
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  credit_transactions credit_transactions[]
  users               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model email_templates {
  id                                                           String            @id
  userId                                                       String
  name                                                         String
  type                                                         EmailTemplateType
  subject                                                      String
  bodyHtml                                                     String
  bodyText                                                     String?
  variables                                                    Json              @default("{}")
  isDefault                                                    Boolean           @default(false)
  isActive                                                     Boolean           @default(true)
  createdAt                                                    DateTime          @default(now())
  updatedAt                                                    DateTime
  users                                                        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  emails                                                       Email[]
  interviews_interviews_emailTemplateIdToemail_templates       interviews[]      @relation("interviews_emailTemplateIdToemail_templates")
  interviews_interviews_reminder24hTemplateIdToemail_templates interviews[]      @relation("interviews_reminder24hTemplateIdToemail_templates")
  interviews_interviews_reminder6hTemplateIdToemail_templates  interviews[]      @relation("interviews_reminder6hTemplateIdToemail_templates")
  sequenceSteps                                                SequenceStep[]

  @@index([userId, type, isDefault])
}

model interviews {
  id                                                                String                @id
  userId                                                            String
  candidateId                                                       String?
  linkedInCandidateId                                               String?
  jobId                                                             String?
  source                                                            InterviewSource
  linkToken                                                         String                @unique
  interviewLink                                                     String
  vapiAssistantId                                                   String?
  vapiCallId                                                        String?
  emailTemplateId                                                   String?
  customEmailSubject                                                String?
  customEmailBody                                                   String?
  status                                                            InterviewStatus       @default(PENDING)
  linkSentAt                                                        DateTime?
  linkOpenedAt                                                      DateTime?
  linkExpiresAt                                                     DateTime
  startedAt                                                         DateTime?
  completedAt                                                       DateTime?
  abandonedAt                                                       DateTime?
  duration                                                          Int?
  emailSent                                                         Boolean               @default(false)
  remindersSent                                                     Int                   @default(0)
  lastReminderAt                                                    DateTime?
  transcript                                                        String?
  rawMessages                                                       Json?
  recordingUrl                                                      String?
  overallScore                                                      Int?
  technicalScore                                                    Int?
  communicationScore                                                Int?
  cultureFitScore                                                   Int?
  strengths                                                         String[]
  concerns                                                          String[]
  keyInsights                                                       String?
  recommendation                                                    HiringRecommendation?
  detailedAnalysis                                                  Json?
  abandonedAtQuestion                                               String?
  noShowReason                                                      String?
  createdAt                                                         DateTime              @default(now())
  updatedAt                                                         DateTime
  sourcingJobId                                                     String?
  enable24hReminder                                                 Boolean               @default(true)
  enable6hReminder                                                  Boolean               @default(true)
  reminder24hTemplateId                                             String?
  reminder6hTemplateId                                              String?
  scheduledSendAt                                                   DateTime?
  candidates                                                        Candidate?            @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  email_templates_interviews_emailTemplateIdToemail_templates       email_templates?      @relation("interviews_emailTemplateIdToemail_templates", fields: [emailTemplateId], references: [id])
  jobs                                                              Job?                  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  LinkedInCandidate                                                 LinkedInCandidate?    @relation(fields: [linkedInCandidateId], references: [id], onDelete: Cascade)
  email_templates_interviews_reminder24hTemplateIdToemail_templates email_templates?      @relation("interviews_reminder24hTemplateIdToemail_templates", fields: [reminder24hTemplateId], references: [id])
  email_templates_interviews_reminder6hTemplateIdToemail_templates  email_templates?      @relation("interviews_reminder6hTemplateIdToemail_templates", fields: [reminder6hTemplateId], references: [id])
  SourcingJob                                                       SourcingJob?          @relation(fields: [sourcingJobId], references: [id], onDelete: Cascade)
  users                                                             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([jobId])
  @@index([linkToken])
  @@index([linkedInCandidateId])
  @@index([sourcingJobId])
  @@index([userId, status])
  @@index([vapiCallId])
}

model Sequence {
  id                 String              @id @default(cuid())
  userId             String
  name               String
  description        String?
  isActive           Boolean             @default(true)
  totalSteps         Int                 @default(0)
  delayBetweenSteps  Int                 @default(3)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  candidateSequences CandidateSequence[]
  emails             Email[]
  steps              SequenceStep[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("sequences")
}

model SequenceStep {
  id              String           @id @default(cuid())
  sequenceId      String
  stepNumber      Int
  emailTemplateId String?
  subject         String?
  bodyHtml        String?
  bodyText        String?
  delayDays       Int              @default(0)
  delayHours      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  emails          Email[]
  emailTemplate   email_templates? @relation(fields: [emailTemplateId], references: [id])
  sequence        Sequence         @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
  @@map("sequence_steps")
}

model CandidateSequence {
  id                   String                  @id @default(cuid())
  sequenceId           String
  candidateId          String?
  linkedInCandidateId  String?
  status               CandidateSequenceStatus @default(ACTIVE)
  currentStep          Int                     @default(1)
  startedAt            DateTime                @default(now())
  completedAt          DateTime?
  pausedAt             DateTime?
  cancelledAt          DateTime?
  cancelReason         String?
  nextEmailScheduledAt DateTime?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  candidate            Candidate?              @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  linkedInCandidate    LinkedInCandidate?      @relation(fields: [linkedInCandidateId], references: [id], onDelete: Cascade)
  sequence             Sequence                @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  emails               Email[]

  @@index([sequenceId, status])
  @@index([candidateId])
  @@index([linkedInCandidateId])
  @@index([status, nextEmailScheduledAt])
  @@map("candidate_sequences")
}

model Email {
  id                  String             @id @default(cuid())
  userId              String
  candidateId         String?
  linkedInCandidateId String?
  sequenceId          String?
  sequenceStepId      String?
  candidateSequenceId String?
  emailTemplateId     String?
  to                  String
  from                String
  subject             String
  bodyHtml            String
  bodyText            String?
  status              EmailStatus        @default(SCHEDULED)
  scheduledAt         DateTime?
  sentAt              DateTime?
  deliveredAt         DateTime?
  bouncedAt           DateTime?
  openedAt            DateTime?
  clickedAt           DateTime?
  repliedAt           DateTime?
  resendEmailId       String?
  bounceReason        String?
  errorMessage        String?
  openCount           Int                @default(0)
  clickCount          Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  direction           EmailDirection     @default(OUTBOUND)
  isRead              Boolean            @default(false)
  inReplyTo           String?
  messageId           String?
  candidate           Candidate?         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  candidateSequence   CandidateSequence? @relation(fields: [candidateSequenceId], references: [id])
  emailTemplate       email_templates?   @relation(fields: [emailTemplateId], references: [id])
  linkedInCandidate   LinkedInCandidate? @relation(fields: [linkedInCandidateId], references: [id], onDelete: Cascade)
  sequence            Sequence?          @relation(fields: [sequenceId], references: [id])
  sequenceStep        SequenceStep?      @relation(fields: [sequenceStepId], references: [id])
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([candidateId])
  @@index([linkedInCandidateId])
  @@index([sequenceId])
  @@index([candidateSequenceId])
  @@index([status, scheduledAt])
  @@index([sentAt])
  @@index([resendEmailId])
  @@index([messageId])
  @@map("emails")
}

model checkpoint_blobs {
  thread_id     String
  checkpoint_ns String @default("")
  channel       String
  version       String
  type          String
  blob          Bytes?

  @@id([thread_id, checkpoint_ns, channel, version])
}

model checkpoint_migrations {
  v Int @id
}

model checkpoint_writes {
  thread_id     String
  checkpoint_ns String  @default("")
  checkpoint_id String
  task_id       String
  idx           Int
  channel       String
  type          String?
  blob          Bytes

  @@id([thread_id, checkpoint_ns, checkpoint_id, task_id, idx])
}

model checkpoints {
  thread_id            String
  checkpoint_ns        String  @default("")
  checkpoint_id        String
  parent_checkpoint_id String?
  type                 String?
  checkpoint           Json
  metadata             Json    @default("{}")

  @@id([thread_id, checkpoint_ns, checkpoint_id])
}

enum SourcingJobStatus {
  CREATED
  FORMATTING_JD
  JD_FORMATTED
  SEARCHING_PROFILES
  PROFILES_FOUND
  SCRAPING_PROFILES
  PARSING_PROFILES
  SAVING_PROFILES
  SCORING_PROFILES
  COMPLETED
  RATE_LIMITED
  FAILED
}

enum InterviewReadinessStatus {
  NOT_ASSESSED
  READY_TO_INTERVIEW
  INTERVIEW_WITH_VALIDATION
  NOT_RECOMMENDED
}

enum CandidateEnrichmentStatus {
  PENDING
  ENRICHED
  NO_EMAIL_FOUND
  SKIPPED
}

enum CreditCategory {
  SOURCING
  SCREENING
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum TransactionType {
  CREDIT
  DEBIT
  RESET
  REFUND
}

enum EmailTemplateType {
  INTERVIEW_INVITATION
  REMINDER_24H
  REMINDER_6H
  FOLLOW_UP
  CUSTOM
}

enum HiringRecommendation {
  STRONG_YES
  YES
  MAYBE
  NO
}

enum InterviewSource {
  SCREENING
  SOURCING
}

enum InterviewStatus {
  PENDING
  LINK_SENT
  LINK_OPENED
  IN_PROGRESS
  COMPLETED
  ABANDONED
  EXPIRED
  NO_SHOW
  CANCELLED
}

enum CandidateSequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
}

enum EmailStatus {
  SCHEDULED
  SENDING
  SENT
  DELIVERED
  BOUNCED
  OPENED
  CLICKED
  REPLIED
  FAILED
}

enum EmailDirection {
  OUTBOUND
  INBOUND
}
